# meta-my-project

Custom Yocto/OpenEmbedded layer for NVIDIA Jetson Orin Nano with DisplayPort and IMX219 camera support.

## Description

This layer provides custom configuration and recipes for Jetson Orin Nano 4GB Developer Kit:
- **DisplayPort/HDMI output** via nvidia-drm with KMS support
- **IMX219 camera** on CAM1 (CSI-C) port with Device Tree overlays
- **Custom distro configuration** (`my-distro`)
- **Bootloader configuration** for FDT and DTBO support

## Layer Information

- **Layer Name**: meta-my-project
- **Layer Priority**: 6
- **Compatible Yocto**: scarthgap (5.0)
- **Dependencies**: openembedded-core

## Compatible Machines

- `p3768-0000-p3767-0004` (Jetson Orin Nano 4GB Developer Kit)

## Layer Structure

```
meta-my-project/
├── conf/
│   ├── layer.conf                           # Layer configuration
│   └── distro/
│       └── my-distro.conf                   # Custom distro definition
└── recipes-bsp/
    └── uefi/
        └── l4t-launcher-extlinux.bbappend   # FDT/DTBO overlay support
```

## Features

### 1. Custom Distro (my-distro)

Distro configuration includes:
- **Name**: My Project Distro
- **Version**: 1.0.0
- **Features**: OpenGL, Wayland, Vulkan, systemd, virtualization, usrmerge

### 2. DisplayPort/HDMI Support

Pre-configured for nvidia-drm:
- Kernel mode setting enabled (modeset=1)
- Framebuffer device support (fbdev=1)
- Automatic module loading via `nvidia-drm-loadconf`

### 3. IMX219 Camera Support

Device Tree overlay configuration:
- **Sensor**: Sony IMX219 8MP
- **Connection**: CAM1 connector (CSI-C)
- **I2C**: Bus 7, address 0x10
- **DTBO**: `tegra234-p3767-camera-p3768-imx219-C.dtbo`
- **V4L2 device**: `/dev/video0`

### 4. Custom extlinux.conf Generation

Modified `l4t-launcher-extlinux` recipe to support:
- Main Device Tree in `devicetree/` subdirectory
- Multiple Device Tree Overlays
- Automatic directory structure creation

## Usage

### With KAS

Add to your `kas` project file (e.g., `project.yml`):

```yaml
repos:
  meta-my-project:
    url: "https://github.com/YOUR_USERNAME/meta-my-project.git"
    refspec: main
    layers:
      .:

machine: p3768-0000-p3767-0004
distro: my-distro
target: demo-image-egl

local_conf_header:
  my-project: |
    TEGRA_FLASH_USE_NVME = "1"
    TEGRA_BOARDSKU = "0004"
    
    # DisplayPort/HDMI
    IMAGE_INSTALL:append = " nvidia-drm-loadconf kernel-module-nvidia-drm"
    KERNEL_ARGS:append = " nvidia-drm.modeset=1 nvidia-drm.fbdev=1"
    
    # Camera and multimedia
    IMAGE_INSTALL:append = " tegra-argus-daemon tegra-mmapi v4l-utils gstreamer1.0-plugins-tegra"
    
    # Device Tree configuration
    UBOOT_EXTLINUX_FDT = "devicetree/tegra234-p3768-0000+p3767-0004-nv-super.dtb"
    UBOOT_EXTLINUX_FDTOVERLAYS = "devicetree/tegra234-p3767-camera-p3768-imx219-C.dtbo"
```

### With BitBake

Add to `conf/bblayers.conf`:

```
BBLAYERS ?= " \
  /path/to/meta-my-project \
  ... \
"
```

Add to `conf/local.conf`:

```bash
MACHINE = "p3768-0000-p3767-0004"
DISTRO = "my-distro"

# Include configurations as shown above
```

## Building

### With KAS (Recommended)

```bash
kas build project.yml
```

### With BitBake

```bash
source oe-init-build-env build
bitbake demo-image-egl
```

## Flashing

### Extract Flashing Package

```bash
cd build/tmp-glibc/deploy/images/p3768-0000-p3767-0004/
tar -xvf demo-image-egl-*.tegraflash.tar.gz
cd mfi_p3768-0000-p3767-0004/
```

### Flash to Device

1. Connect Jetson to host via USB-C
2. Put Jetson in Recovery Mode:
   - Hold **RECOVERY** button
   - Press **RESET** button
   - Release **RECOVERY** button
3. Flash:

```bash
sudo ./doflash.sh
```

## Testing

### DisplayPort Verification

```bash
# Check nvidia-drm module
lsmod | grep nvidia_drm
cat /sys/module/nvidia_drm/parameters/modeset  # Should be: Y

# Check DRM device
ls -la /dev/dri/card0

# Check DisplayPort connection
cat /sys/class/drm/card0-DP-1/status  # Should be: connected
```

### Camera Verification

```bash
# Check V4L2 device
v4l2-ctl --list-devices

# Check I2C detection
i2cdetect -y -r 7  # Should show device at 0x10

# Check Device Tree overlay
cat /boot/extlinux/extlinux.conf | grep OVERLAYS
# Should show: OVERLAYS /boot/devicetree/tegra234-p3767-camera-p3768-imx219-C.dtbo

# Test with GStreamer
gst-launch-1.0 nvarguscamerasrc sensor-id=0 ! \
    'video/x-raw(memory:NVMM),width=1920,height=1080,framerate=30/1' ! \
    nvoverlaysink
```

## Configuration Details

### extlinux.conf Example

After building, the generated `/boot/extlinux/extlinux.conf` should contain:

```
# L4TLauncher configuration file generated by OE4T
MENU TITLE L4T boot options
DEFAULT primary
LABEL primary
        MENU LABEL primary
        LINUX /boot/Image
        INITRD /boot/initrd
        FDT /boot/devicetree/tegra234-p3768-0000+p3767-0004-nv-super.dtb
        OVERLAYS /boot/devicetree/tegra234-p3767-camera-p3768-imx219-C.dtbo
        APPEND ${cbootargs} nvidia-drm.modeset=1 nvidia-drm.fbdev=1 ...
```

### ESP Partition Structure

```
/boot/
├── extlinux/
│   └── extlinux.conf
├── Image                    # Kernel
├── initrd                   # InitRAMFS
└── devicetree/              # DTB/DTBO directory
    ├── tegra234-p3768-0000+p3767-0004-nv-super.dtb
    ├── tegra234-p3767-camera-p3768-imx219-C.dtbo
    └── ... (other DTBs/DTBOs)
```

## Troubleshooting

### DisplayPort Not Working

1. Check nvidia-drm module:
```bash
modprobe nvidia-drm modeset=1 fbdev=1
```

2. Verify modprobe configuration:
```bash
cat /etc/modprobe.d/nvidia-drm.conf
```

3. Check kernel log:
```bash
dmesg | grep -i "nvidia-drm\|display"
```

### Camera Not Detected

1. Check hardware connection (ribbon cable)
2. Verify I2C communication:
```bash
i2cdetect -y -r 7
```
3. Check Device Tree overlay loading:
```bash
dmesg | grep -i "imx219\|nvcsi\|vi5"
```
4. Restart argus daemon:
```bash
systemctl restart nvargus-daemon
```

## Dependencies

This layer requires:
- **meta-tegra** (OE4T BSP layer)
- **meta-openembedded** (meta-oe, meta-python)
- **openembedded-core** (or poky)

## Maintenance

### Layer Priority

This layer has priority **6**, which means it can override recipes from lower-priority layers.

### Adding Recipes

To add new recipes, create directories under the layer:

```bash
meta-my-project/
├── recipes-kernel/          # Kernel-related recipes
├── recipes-graphics/        # Graphics-related recipes
├── recipes-multimedia/      # Multimedia recipes
└── ... (other categories)
```

## License

MIT License

Copyright (c) 2025 YOUR_NAME

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

## Maintainer

YOUR_NAME <your.email@example.com>

## References

- [OE4T meta-tegra](https://github.com/OE4T/meta-tegra)
- [OE4T tegra-demo-distro](https://github.com/OE4T/tegra-demo-distro)
- [Jetson Orin Nano Developer Kit](https://developer.nvidia.com/embedded/learn/get-started-jetson-orin-nano-devkit)
- [Yocto Project](https://www.yoctoproject.org/)
- [KAS Documentation](https://kas.readthedocs.io/)

## Changelog

### Version 1.0.0 (2025-11-27)
- Initial release
- DisplayPort/HDMI support with nvidia-drm
- IMX219 camera support on CAM1
- Custom distro configuration
- FDT and DTBO overlay support in extlinux.conf
